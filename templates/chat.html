<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --message-user-bg: #2563eb;
            --message-assistant-bg: #f1f5f9;
            --message-system-bg: #fef3c7;
            --level-low: #ef4444;
            --level-medium: #f59e0b;
            --level-high: #10b981;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .chat-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            height: 92vh;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-main.with-personality {
            border-right: 1px solid var(--border-color);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 0 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .username {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .share-link {
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .share-link input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.8125rem;
        }

        .copy-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .copy-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .leave-room {
            color: white;
            text-decoration: none;
            font-size: 0.875rem;
            opacity: 0.8;
            transition: opacity 0.15s ease;
        }

        .leave-room:hover {
            opacity: 1;
        }

        .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            max-width: 80%;
            font-size: 0.9375rem;
        }

        .message.user {
            background-color: var(--message-user-bg);
            color: white;
            margin-left: auto;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }

        .message.assistant {
            background-color: var(--message-assistant-bg);
            color: var(--text-primary);
            margin-right: auto;
        }

        .message.system {
            background-color: var(--message-system-bg);
            color: var(--text-primary);
            margin: 0 auto;
            text-align: center;
            font-style: italic;
            font-size: 0.875rem;
        }

        .message .sender {
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 0.8125rem;
            opacity: 0.9;
        }

        .input-area {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            background-color: white;
        }

        #messageInput {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: inherit;
            transition: border-color 0.15s ease;
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        #sendButton {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        #sendButton:hover {
            background-color: var(--primary-hover);
        }

        .side-panel {
            width: 280px;
            padding: 1.25rem;
            background-color: #f8fafc;
            border-radius: 0 12px 12px 0;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .task-section {
            border-top: 1px solid var(--border-color);
            padding-top: 1.25rem;
        }

        .task-content {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.5;
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .participants-section {
            margin-bottom: 1rem;
        }

        .panel-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .participants-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .participant {
            padding: 0.625rem;
            border-radius: 6px;
            background-color: white;
            color: var(--text-primary);
            font-size: 0.875rem;
            border: 1px solid var(--border-color);
        }

        .personality-panel {
            width: 320px;
            padding: 1.25rem;
            background-color: #f8fafc;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .personality-section {
            margin-top: 1rem;
        }

        .personality-section h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .trait-edit-item {
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .trait-edit-item:last-child {
            border-bottom: none;
        }

        .trait-edit-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
        }

        .trait-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .trait-level-description {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background-color: #f8fafc;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #475569;
            line-height: 1.4;
        }

        .section-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .trait-item {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .subtrait-item {
            margin: 0.5rem 0 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .subtrait-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .subtrait-behavior {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            line-height: 1.4;
            margin-left: 0.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid var(--border-color);
        }

        .personality-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .edit-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .edit-button:hover {
            background-color: var(--primary-hover);
        }

        .toggle-behaviors {
            font-size: 0.75rem;
            color: var(--primary-color);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-top: 0.25rem;
            text-decoration: underline;
        }

        .trait-name {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.375rem;
            font-weight: 500;
        }

        .trait-bar {
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .trait-level {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .trait-description {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.375rem;
            line-height: 1.4;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 5vh auto;
            padding: 1.5rem;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.15s ease;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .modal input[type="range"] {
            width: 100%;
            margin: 0.5rem 0;
        }

        .modal label {
            display: block;
            margin-top: 1.25rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .modal .value-display {
            display: inline-block;
            margin-left: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .save-button {
            margin-top: 1.5rem;
            background-color: #22c55e;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: background-color 0.15s ease;
        }

        .save-button:hover {
            background-color: #16a34a;
        }

        #messages { 
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
        }
        .user { background-color: #e3f2fd; }
        .ai { background-color: #f5f5f5; }

        .trait-level-category {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-top: 0.25rem;
        }
        
        .level-low {
            background-color: var(--level-low);
            color: white;
        }
        
        .level-medium {
            background-color: var(--level-medium);
            color: white;
        }
        
        .level-high {
            background-color: var(--level-high);
            color: white;
        }

        .personality-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .behaviors-container {
            margin-top: 0.75rem;
            background-color: white;
            border-radius: 6px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .subtrait-item:not(:last-child) {
            margin-bottom: 0.75rem;
        }

        .toggle-behaviors {
            font-size: 0.75rem;
            color: var(--primary-color);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-top: 0.5rem;
            text-decoration: underline;
            display: block;
        }

        .toggle-behaviors:hover {
            color: var(--primary-hover);
        }

        .trait-edit-item {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .trait-level-description {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 0.375rem;
            padding: 0.375rem;
            background-color: #f1f5f9;
            border-radius: 4px;
            line-height: 1.3;
        }

        .subcomponents-list {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .subcomponent-item {
            margin: 0.25rem 0;
            font-size: 0.8125rem;
        }
        
        .subcomponent-name {
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }
        
        .trait-edit-header {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: block;
            font-size: 1rem;
        }
        
        .subcomponent-edit {
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
            border-left: 2px solid var(--border-color);
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <div class="chat-container">
        {% if ai_enabled %}
        <div class="personality-panel">
            <div class="personality-header">
                <span>AI Personality: {{ personality.name }}</span>
                <button class="edit-button" onclick="openModal()">Edit</button>
            </div>
            
            <div class="personality-description">
                {{ personality.description }}
            </div>
            
            <div class="personality-section">
                <div class="section-title">Traits & Behaviors</div>
                <div id="behaviorMap" style="display: none;">{{ behavior_map|tojson }}</div>
                
                {% for trait, subcomponents in personality.traits.items() %}
                <div class="trait-item" data-trait="{{ trait }}">
                    <div class="trait-name">{{ trait|replace('_', ' ')|title }}</div>
                    
                    <!-- Display subcomponents -->
                    {% if subcomponents|length > 0 %}
                        <div class="subcomponents-list">
                        {% for subcomponent, level in subcomponents.items() %}
                            <div class="subcomponent-item">
                                <span class="subcomponent-name">{{ subcomponent|replace('_', ' ')|title }}:</span>
                                <span class="trait-level-category level-{{ level }}">{{ level|title }}</span>
                </div>
                {% endfor %}
            </div>
                    {% endif %}
                    
                    <button class="toggle-behaviors" onclick="toggleBehaviors('{{ trait }}')">Show behaviors</button>
                    <div class="behaviors-container" id="behaviors-{{ trait }}" style="display: none;"></div>
                </div>
                {% endfor %}
            </div>
            
            <div class="personality-section">
                <div class="section-title">Response Characteristics</div>
                {% for char, value in personality.response_characteristics.items() %}
                <div class="trait-item">
                    <div class="trait-name">{{ char|replace('_', ' ')|title }}</div>
                    <div class="trait-description">{{ value }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="chat-main {% if ai_enabled %}with-personality{% endif %}">
            <div class="chat-header">
                <div class="header-info">
                    <h2>{{ room_name }}</h2>
                    <span class="username">Joined as {{ username }}</span>
                    <div class="share-link">
                        <input type="text" id="shareLink" value="{{ share_url }}" readonly>
                        <button onclick="copyShareLink()" class="copy-button">Copy Link</button>
                    </div>
                </div>
                <a href="/" class="leave-room">Leave Room</a>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type your message...">
                <button id="sendButton">Send</button>
            </div>
        </div>
        
        <div class="side-panel">
            <div class="participants-section">
                <h3 class="panel-header">Participants</h3>
                <ul class="participants-list">
                    {% for participant in participants %}
                    <li class="participant">{{ participant }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% if task %}
            <div class="task-section">
                <h3 class="panel-header">Current Task</h3>
                <div class="task-content">
                    {{ task }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Personality Edit Modal -->
    {% if ai_enabled %}
    <div id="personalityModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2>Edit AI Personality</h2>
            
            <form id="personalityForm" onsubmit="savePersonality(event)">
                <div class="personality-section">
                    <h3>Personality Details</h3>
                    <div class="trait-edit-item">
                        <label>
                            Name
                            <input type="text" name="name" class="trait-select" value="{{ personality.name }}" required>
                        </label>
                        <div class="trait-level-description">
                            A distinctive name for this AI personality.
                        </div>
                    </div>
                    
                    <div class="trait-edit-item">
                        <label>
                            Description
                            <textarea name="description" class="trait-select" style="height: 100px; resize: vertical;" required>{{ personality.description }}</textarea>
                        </label>
                        <div class="trait-level-description">
                            Brief description of this personality's key characteristics.
                        </div>
                    </div>
                    
                    <h3>Traits</h3>
                    
                    <!-- Hidden field for communication_style -->
                    <input type="hidden" name="communication_style" value="standard">
                    
                    <!-- Emotional Stability -->
                    <div class="trait-edit-item">
                        <label class="trait-edit-header">Emotional Stability</label>
                        
                        <div class="subcomponent-edit">
                    <label>
                                Adjustment
                                <select name="trait_emotional_stability_adjustment" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.emotional_stability.adjustment == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.emotional_stability.adjustment == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.emotional_stability.adjustment == 'high' %}selected{% endif %}>High</option>
                                </select>
                    </label>
                            <div class="trait-level-description" id="desc-emotional_stability_adjustment-low" style="display: {% if personality.traits.emotional_stability.adjustment == 'low' %}block{% else %}none{% endif %}">
                                Display anxious, uncertain behaviors.
                            </div>
                            <div class="trait-level-description" id="desc-emotional_stability_adjustment-medium" style="display: {% if personality.traits.emotional_stability.adjustment == 'medium' %}block{% else %}none{% endif %}">
                                Remain calm, showing moderate confidence.
                            </div>
                            <div class="trait-level-description" id="desc-emotional_stability_adjustment-high" style="display: {% if personality.traits.emotional_stability.adjustment == 'high' %}block{% else %}none{% endif %}">
                                Exhibit poise and resilience, offering reassurance in stressful situations.
                            </div>
                        </div>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Self Esteem
                                <select name="trait_emotional_stability_self_esteem" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.emotional_stability.self_esteem == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.emotional_stability.self_esteem == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.emotional_stability.self_esteem == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-emotional_stability_self_esteem-low" style="display: {% if personality.traits.emotional_stability.self_esteem == 'low' %}block{% else %}none{% endif %}">
                                Show self-doubt, hesitancy in suggestions.
                            </div>
                            <div class="trait-level-description" id="desc-emotional_stability_self_esteem-medium" style="display: {% if personality.traits.emotional_stability.self_esteem == 'medium' %}block{% else %}none{% endif %}">
                                Display a balanced sense of confidence.
                            </div>
                            <div class="trait-level-description" id="desc-emotional_stability_self_esteem-high" style="display: {% if personality.traits.emotional_stability.self_esteem == 'high' %}block{% else %}none{% endif %}">
                                Exude confidence in decisions and promote self-assured actions.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Extraversion -->
                    <div class="trait-edit-item">
                        <label class="trait-edit-header">Extraversion</label>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Dominance
                                <select name="trait_extraversion_dominance" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.extraversion.dominance == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.extraversion.dominance == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.extraversion.dominance == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-extraversion_dominance-low" style="display: {% if personality.traits.extraversion.dominance == 'low' %}block{% else %}none{% endif %}">
                                Adopt a reserved, passive role in discussions.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_dominance-medium" style="display: {% if personality.traits.extraversion.dominance == 'medium' %}block{% else %}none{% endif %}">
                                Engage actively but not overpoweringly.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_dominance-high" style="display: {% if personality.traits.extraversion.dominance == 'high' %}block{% else %}none{% endif %}">
                                Take charge, offer assertive guidance, and direct team actions.
                            </div>
                        </div>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Affiliation
                                <select name="trait_extraversion_affiliation" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.extraversion.affiliation == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.extraversion.affiliation == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.extraversion.affiliation == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-extraversion_affiliation-low" style="display: {% if personality.traits.extraversion.affiliation == 'low' %}block{% else %}none{% endif %}">
                                Maintain professional distance, focus on task completion over relationships.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_affiliation-medium" style="display: {% if personality.traits.extraversion.affiliation == 'medium' %}block{% else %}none{% endif %}">
                                Balance task focus with relationship building.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_affiliation-high" style="display: {% if personality.traits.extraversion.affiliation == 'high' %}block{% else %}none{% endif %}">
                                Actively build team relationships and foster a sense of belonging.
                            </div>
                        </div>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Social Perceptiveness
                                <select name="trait_extraversion_social_perceptiveness" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.extraversion.social_perceptiveness == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.extraversion.social_perceptiveness == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.extraversion.social_perceptiveness == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-extraversion_social_perceptiveness-low" style="display: {% if personality.traits.extraversion.social_perceptiveness == 'low' %}block{% else %}none{% endif %}">
                                Focus primarily on factual content rather than social cues.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_social_perceptiveness-medium" style="display: {% if personality.traits.extraversion.social_perceptiveness == 'medium' %}block{% else %}none{% endif %}">
                                Balance attention between content and social dynamics.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_social_perceptiveness-high" style="display: {% if personality.traits.extraversion.social_perceptiveness == 'high' %}block{% else %}none{% endif %}">
                                Demonstrate high awareness of team dynamics and unspoken feelings.
                            </div>
                        </div>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Expressivity
                                <select name="trait_extraversion_expressivity" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.extraversion.expressivity == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.extraversion.expressivity == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.extraversion.expressivity == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-extraversion_expressivity-low" style="display: {% if personality.traits.extraversion.expressivity == 'low' %}block{% else %}none{% endif %}">
                                Communicate in a concise, reserved manner with minimal elaboration.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_expressivity-medium" style="display: {% if personality.traits.extraversion.expressivity == 'medium' %}block{% else %}none{% endif %}">
                                Express thoughts clearly with appropriate detail and energy.
                            </div>
                            <div class="trait-level-description" id="desc-extraversion_expressivity-high" style="display: {% if personality.traits.extraversion.expressivity == 'high' %}block{% else %}none{% endif %}">
                                Communicate enthusiastically with animated language and engaging style.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Openness -->
                    <div class="trait-edit-item">
                        <label class="trait-edit-header">Openness</label>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Flexibility
                                <select name="trait_openness_flexibility" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.openness.flexibility == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.openness.flexibility == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.openness.flexibility == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-openness_flexibility-low" style="display: {% if personality.traits.openness.flexibility == 'low' %}block{% else %}none{% endif %}">
                                Prefer established approaches and conventional thinking.
                            </div>
                            <div class="trait-level-description" id="desc-openness_flexibility-medium" style="display: {% if personality.traits.openness.flexibility == 'medium' %}block{% else %}none{% endif %}">
                                Balance traditional methods with openness to new ideas.
                            </div>
                            <div class="trait-level-description" id="desc-openness_flexibility-high" style="display: {% if personality.traits.openness.flexibility == 'high' %}block{% else %}none{% endif %}">
                                Embrace novel approaches and creative thinking.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Agreeableness -->
                    <div class="trait-edit-item">
                        <label class="trait-edit-header">Agreeableness</label>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Trust
                                <select name="trait_agreeableness_trust" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.agreeableness.trust == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.agreeableness.trust == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.agreeableness.trust == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-agreeableness_trust-low" style="display: {% if personality.traits.agreeableness.trust == 'low' %}block{% else %}none{% endif %}">
                                Approach team discussions with healthy skepticism and verification.
                            </div>
                            <div class="trait-level-description" id="desc-agreeableness_trust-medium" style="display: {% if personality.traits.agreeableness.trust == 'medium' %}block{% else %}none{% endif %}">
                                Balance trust with appropriate verification.
                            </div>
                            <div class="trait-level-description" id="desc-agreeableness_trust-high" style="display: {% if personality.traits.agreeableness.trust == 'high' %}block{% else %}none{% endif %}">
                                Extend trust readily and assume positive intentions from team members.
                            </div>
                        </div>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Cooperation
                                <select name="trait_agreeableness_cooperation" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.agreeableness.cooperation == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.agreeableness.cooperation == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.agreeableness.cooperation == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-agreeableness_cooperation-low" style="display: {% if personality.traits.agreeableness.cooperation == 'low' %}block{% else %}none{% endif %}">
                                Prioritize direct communication and challenge others' ideas.
                            </div>
                            <div class="trait-level-description" id="desc-agreeableness_cooperation-medium" style="display: {% if personality.traits.agreeableness.cooperation == 'medium' %}block{% else %}none{% endif %}">
                                Balance cooperation with appropriate assertiveness.
                            </div>
                            <div class="trait-level-description" id="desc-agreeableness_cooperation-high" style="display: {% if personality.traits.agreeableness.cooperation == 'high' %}block{% else %}none{% endif %}">
                                Emphasize team harmony and consensus-building.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conscientiousness -->
                    <div class="trait-edit-item">
                        <label class="trait-edit-header">Conscientiousness</label>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Dependability
                                <select name="trait_conscientiousness_dependability" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.conscientiousness.dependability == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.conscientiousness.dependability == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.conscientiousness.dependability == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-conscientiousness_dependability-low" style="display: {% if personality.traits.conscientiousness.dependability == 'low' %}block{% else %}none{% endif %}">
                                Adapt quickly to changing priorities without extensive planning.
                            </div>
                            <div class="trait-level-description" id="desc-conscientiousness_dependability-medium" style="display: {% if personality.traits.conscientiousness.dependability == 'medium' %}block{% else %}none{% endif %}">
                                Balance reliability with flexibility to adjust plans.
                            </div>
                            <div class="trait-level-description" id="desc-conscientiousness_dependability-high" style="display: {% if personality.traits.conscientiousness.dependability == 'high' %}block{% else %}none{% endif %}">
                                Demonstrate exceptional reliability and follow-through on commitments.
                            </div>
                        </div>
                        
                        <div class="subcomponent-edit">
                            <label>
                                Achievement
                                <select name="trait_conscientiousness_achievement" class="trait-select" onchange="showTraitDescription(this)">
                                    <option value="low" {% if personality.traits.conscientiousness.achievement == 'low' %}selected{% endif %}>Low</option>
                                    <option value="medium" {% if personality.traits.conscientiousness.achievement == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="high" {% if personality.traits.conscientiousness.achievement == 'high' %}selected{% endif %}>High</option>
                                </select>
                            </label>
                            <div class="trait-level-description" id="desc-conscientiousness_achievement-low" style="display: {% if personality.traits.conscientiousness.achievement == 'low' %}block{% else %}none{% endif %}">
                                Focus on adequate results without unnecessary perfectionism.
                            </div>
                            <div class="trait-level-description" id="desc-conscientiousness_achievement-medium" style="display: {% if personality.traits.conscientiousness.achievement == 'medium' %}block{% else %}none{% endif %}">
                                Strive for quality results without excessive perfectionism.
                            </div>
                            <div class="trait-level-description" id="desc-conscientiousness_achievement-high" style="display: {% if personality.traits.conscientiousness.achievement == 'high' %}block{% else %}none{% endif %}">
                                Demonstrate exceptional attention to detail and thoroughness.
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <div class="personality-section">
                    <h3>Response Characteristics</h3>
                    <div class="trait-edit-item">
                    <label>
                            Response Length
                            <select name="response_length" class="trait-select">
                                <option value="short" {% if personality.response_characteristics.response_length == 'short' %}selected{% endif %}>Short</option>
                                <option value="medium" {% if personality.response_characteristics.response_length == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="long" {% if personality.response_characteristics.response_length == 'long' %}selected{% endif %}>Long</option>
                            </select>
                    </label>
                        <div class="trait-level-description">
                            Controls how verbose the AI's responses will be in conversations.
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="save-button">Save Changes</button>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        // Add a custom :contains selector polyfill similar to jQuery
        // This allows us to use querySelector with :contains() which is not standard
        document.querySelectorAll = (function(originalQsa) {
            return function(selector) {
                try {
                    if (selector.includes(":contains(")) {
                        // Extract the search text and element selector
                        const regex = /(.*):contains\((['"])(.*?)\2\)(.*)/;
                        const match = selector.match(regex);
                        
                        if (match) {
                            const [_, beforeContains, quote, searchText, afterContains] = match;
                            const newSelector = beforeContains + afterContains;
                            
                            // Get all elements matching the base selector
                            const elements = originalQsa.call(this, newSelector);
                            
                            // Filter for elements containing the text
                            return Array.from(elements).filter(el => 
                                el.textContent.includes(searchText)
                            );
                        }
                    }
                    
                    // Fall back to normal selector
                    return originalQsa.call(this, selector);
                } catch (e) {
                    console.error("Error with custom selector:", e);
                    // Fall back to normal selector on error
                    return originalQsa.call(this, selector);
                }
            };
        })(document.querySelectorAll);
        
        // Initialize socket with reconnection options
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
        });

        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const participantsList = document.querySelector('.participants-list');
        const username = "{{ username }}";
        const roomId = "{{ room_id }}";

        function addMessage(data) {
            // Skip messages with undefined user or text
            if (!data.user || !data.text) {
                console.log("Skipping message with undefined data:", data);
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.user === username ? 'user' : data.user === 'System' ? 'system' : 'assistant'}`;
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'sender';
            senderDiv.textContent = data.user;
            
            const textDiv = document.createElement('div');
            textDiv.textContent = data.text;
            
            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(textDiv);
            messages.appendChild(messageDiv);
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
        }

        function updateParticipants(data) {
            if (!participantsList) return;
            
            participantsList.innerHTML = '';
            data.participants.forEach(participant => {
                const li = document.createElement('li');
                li.className = 'participant';
                li.textContent = participant;
                participantsList.appendChild(li);
            });
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                console.log('Sending message:', message);
                
                // Create message data object
                const messageData = {
                    text: message,
                    user: username,
                    room_id: roomId
                };
                
                console.log('Message data:', messageData);
                
                // Emit message event with data
                socket.emit('message', messageData);
                
                // Clear input field
                messageInput.value = '';
                
                // Add user's message to the UI immediately (optimistic update)
                addMessage({
                    user: username,
                    text: message
                });
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('join', roomId);
            // Don't add "Connected to server" message here - server will send it
        });

        socket.on('connect_error', (error) => {
            console.log('Connection error:', error);
            addMessage({
                user: 'System',
                text: 'Connection error. Attempting to reconnect...'
            });
        });

        socket.on('reconnect', (attemptNumber) => {
            console.log('Reconnected after', attemptNumber, 'attempts');
            socket.emit('join', roomId);  // Rejoin room after reconnection
            addMessage({
                user: 'System',
                text: 'Reconnected to server'
            });
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            addMessage({
                user: 'System',
                text: 'Disconnected from server. Attempting to reconnect...'
            });
        });

        // Track if we've loaded history to prevent duplicates
        let historyLoaded = false;
        
        // Handle conversation history when joining
        socket.on('history', (historyMessages) => {
            console.log('Received conversation history:', historyMessages.length, 'messages');
            if (!historyLoaded) {
                // Clear existing messages (from initial page load)
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                // Add all history messages
                historyMessages.forEach(msg => {
                    if (msg && msg.user && (msg.text || msg.text === '')) {
                        addMessage(msg);
                    }
                });
                
                historyLoaded = true;
                console.log('History loaded');
            }
        });
        
        socket.on('message', (data) => {
            console.log('Received message:', data);
            
            // Ensure data has user and text properties
            if (data && data.user && (data.text || data.text === '')) {
                // Skip if this is our own message that we already added optimistically
                if (data.user === username) {
                    // Check if this message is already in the DOM
                    const messagesContainer = document.getElementById('messages');
                    const existingMessages = Array.from(messagesContainer.querySelectorAll('.message'));
                    const isDuplicate = existingMessages.some(msgEl => {
                        const sender = msgEl.querySelector('.sender')?.textContent;
                        const text = msgEl.querySelector('div:last-child')?.textContent;
                        return sender === data.user && text === data.text;
                    });
                    
                    if (isDuplicate) {
                        console.log('Skipping duplicate message from self:', data);
                        return;
                    }
                }
                
                addMessage(data);
            } else {
                console.log("Received invalid message data:", data);
            }
        });

        socket.on('update_participants', (data) => {
            updateParticipants(data);
        });

        // Personality modal functions
        function openModal() {
            const modal = document.getElementById('personalityModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('personalityModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function updateValue(input) {
            const value = (input.value / 100).toFixed(2);
            input.nextElementSibling.textContent = value;
        }
        
        function savePersonality(event) {
            event.preventDefault();
            console.log('Save personality triggered');
            
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                console.log('Loading overlay shown');
            } else {
                console.log('ERROR: Loading overlay element not found!');
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const personality = {
                name: formData.get('name'),
                description: formData.get('description'),
                traits: {},
                response_characteristics: {
                    response_length: formData.get('response_length')
                },
                communication_style: formData.get('communication_style') || 'standard'
            };
            
            console.log('Form data - Name:', personality.name);
            console.log('Form data - Description:', personality.description);
            
            // Process trait form data
            // Create an object to store the subcomponents by their parent traits
            const traitSubcomponents = {};
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('trait_')) {
                    // Extract the parts (e.g., from 'trait_emotional_stability_adjustment')
                    const parts = key.split('_');
                    // First part is 'trait', second is the main trait, the rest form the subcomponent
                    if (parts.length >= 3) {
                        const mainTrait = parts[1]; // e.g., 'emotional'
                        const mainTraitPart2 = parts.length > 3 ? parts[2] : ''; // e.g., 'stability'
                        
                        // Construct the main trait name
                        let traitName;
                        if (mainTraitPart2) {
                            traitName = `${mainTrait}_${mainTraitPart2}`; // e.g., 'emotional_stability'
                        } else {
                            traitName = mainTrait;
                        }
                        
                        // Get the subcomponent name (the rest of the parts after trait and main trait)
                        let subcomponentParts;
                        if (mainTraitPart2) {
                            subcomponentParts = parts.slice(3); // e.g., ['adjustment']
                        } else {
                            subcomponentParts = parts.slice(2);
                        }
                        
                        const subcomponentName = subcomponentParts.join('_'); // e.g., 'adjustment'
                        
                        // Initialize the trait object if not exists
                        if (!traitSubcomponents[traitName]) {
                            traitSubcomponents[traitName] = {};
                        }
                        
                        // Add the subcomponent
                        traitSubcomponents[traitName][subcomponentName] = value;
                    }
                }
            }
            
            // Add the processed trait subcomponents to the personality object
            personality.traits = traitSubcomponents;
            
            console.log('Sending personality update:', personality);
            socket.emit('update_personality', personality);
            
            // Set a timeout to hide the loading overlay in case the server doesn't respond
            setTimeout(() => {
                if (loadingOverlay && loadingOverlay.style.display === 'flex') {
                    console.log('Timeout: closing overlay after 10 seconds');
                    loadingOverlay.style.display = 'none';
            closeModal();
                    alert('The update is taking longer than expected. The changes may still be applied.');
                }
            }, 10000);
        }
        
        // Move the socket.on handler outside of any function to ensure it's registered
        socket.on('personality_updated', function(data) {
            console.log('Received personality_updated event:', data);
            console.log('Name from server:', data.name);
            console.log('Description from server:', data.description);
            
            // DEBUG: Check DOM structure
            const personalityPanel = document.querySelector('.personality-panel');
            if (personalityPanel) {
                console.log('Personality panel found:', personalityPanel);
            } else {
                console.log('ERROR: No personality panel found!');
            }
            
            // Find elements using specific selectors
            const nameElement = document.querySelector('.personality-header span');
            const descriptionElement = document.querySelector('.personality-description');
            
            console.log('Name element:', nameElement);
            console.log('Description element:', descriptionElement);
            
            // Update the UI directly
            if (nameElement && data.name) {
                console.log('Updating name to:', data.name);
                nameElement.textContent = 'AI Personality: ' + data.name;
            }
            
            if (descriptionElement && data.description) {
                console.log('Updating description to:', data.description);
                descriptionElement.textContent = data.description;
            }
            
            // Update trait displays
            if (data.traits) {
                updateTraits(data.traits);
            }
            
            // Hide loading overlay if it's visible
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
                console.log('Loading overlay hidden');
            }
            
            // Close modal if it's open
            closeModal();
        });
        
        function updateTraits(traits) {
            console.log('Updating traits:', traits);
            // Update each trait section
            for (const [traitName, subcomponents] of Object.entries(traits)) {
                const traitElement = document.querySelector(`[data-trait="${traitName}"]`);
                if (traitElement) {
                    console.log(`Found trait element for ${traitName}`);
                    const subcomponentsList = traitElement.querySelector('.subcomponents-list');
                    if (subcomponentsList) {
                        // Clear existing subcomponents
                        subcomponentsList.innerHTML = '';
                        
                        // Add updated subcomponents
                        for (const [subcomponent, level] of Object.entries(subcomponents)) {
                            const subItem = document.createElement('div');
                            subItem.className = 'subcomponent-item';
                            
                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'subcomponent-name';
                            nameSpan.textContent = subcomponent.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) + ':';
                            
                            const levelSpan = document.createElement('span');
                            levelSpan.className = `trait-level-category level-${level}`;
                            levelSpan.textContent = level.charAt(0).toUpperCase() + level.slice(1);
                            
                            subItem.appendChild(nameSpan);
                            subItem.appendChild(levelSpan);
                            subcomponentsList.appendChild(subItem);
                        }
                    }
                }
            }
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            
            // Visual feedback
            const copyButton = document.querySelector('.copy-button');
            const originalText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = originalText;
            }, 2000);
        }

        // Don't load messages via fetch - we'll get them via Socket.IO history event
        // This prevents duplicates when someone joins

        // Behavior map functionality
        function toggleBehaviors(trait) {
            const container = document.getElementById(`behaviors-${trait}`);
            const button = document.querySelector(`[data-trait="${trait}"] .toggle-behaviors`);
            
            if (container.style.display === 'none') {
                // Load behaviors if not already loaded
                if (container.children.length === 0) {
                    loadBehaviors(trait, container);
                }
                container.style.display = 'block';
                button.textContent = 'Hide behaviors';
            } else {
                container.style.display = 'none';
                button.textContent = 'Show behaviors';
            }
        }
        
        function loadBehaviors(trait, container) {
            try {
                // Get behavior map from hidden div
                const behaviorMapElement = document.getElementById('behaviorMap');
                const behaviorMap = JSON.parse(behaviorMapElement.textContent);
                
                // Get trait subcomponents from behavior map
                const traitBehaviors = behaviorMap[trait];
                
                if (traitBehaviors) {
                    // Create elements for each subtrait
                    for (const [subtrait, behaviors] of Object.entries(traitBehaviors)) {
                        const subtraitDiv = document.createElement('div');
                        subtraitDiv.className = 'subtrait-item';
                        
                        const subtraitName = document.createElement('div');
                        subtraitName.className = 'subtrait-name';
                        subtraitName.textContent = subtrait.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        
                        // Find the level for this subcomponent
                        let level = 'medium'; // Default to medium
                        
                        // Find the corresponding subcomponent item in the DOM
                        const subcomponentItems = document.querySelectorAll(`[data-trait="${trait}"] .subcomponent-item`);
                        for (const item of subcomponentItems) {
                            const nameEl = item.querySelector('.subcomponent-name');
                            if (nameEl && nameEl.textContent.toLowerCase().includes(subtrait.replace('_', ' '))) {
                                const levelEl = item.querySelector('.trait-level-category');
                                if (levelEl) {
                                    level = levelEl.textContent.trim().toLowerCase();
                                    break;
                                }
                            }
                        }
                        
                        // If we couldn't find the level, use the first level category we can find
                        if (level === 'medium' && !subcomponentItems.length) {
                            const levelEl = document.querySelector(`[data-trait="${trait}"] .trait-level-category`);
                            if (levelEl) {
                                level = levelEl.textContent.trim().toLowerCase();
                            }
                        }
                        
                        const behaviorText = document.createElement('div');
                        behaviorText.className = 'subtrait-behavior';
                        
                        // Get the behavior for the current level
                        if (behaviors && behaviors[level]) {
                            behaviorText.textContent = behaviors[level];
                        } else {
                            behaviorText.textContent = 'No specific behavior defined for this level.';
                        }
                        
                        subtraitDiv.appendChild(subtraitName);
                        subtraitDiv.appendChild(behaviorText);
                        container.appendChild(subtraitDiv);
                    }
                } else {
                    container.textContent = 'No specific behaviors defined for this trait.';
                }
            } catch (error) {
                console.error('Error loading behaviors:', error);
                container.textContent = 'Error loading behaviors.';
            }
        }

        function showTraitDescription(select) {
            const id = select.name.replace('trait_', '').replace(/_/g, '_');
            const level = select.value;
            
            // Hide all descriptions for this trait
            document.querySelectorAll(`[id^="desc-${id}-"]`).forEach(el => {
                el.style.display = 'none';
            });
            
            // Show the selected level description
            const descElement = document.getElementById(`desc-${id}-${level}`);
            if (descElement) {
                descElement.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add this to log DOM structure on page load
            console.log("Page loaded, checking personality panel structure:");
            const personalityPanel = document.querySelector('.personality-panel');
            if (personalityPanel) {
                console.log("Found personality panel, inner HTML:", personalityPanel.innerHTML);
            } else {
                console.log("No personality panel found on load");
            }
            });
    </script>
</body>
</html> 